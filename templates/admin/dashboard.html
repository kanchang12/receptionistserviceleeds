{% extends "dashboard_base.html" %}
{% block title %}Admin Dashboard — VoiceBot{% endblock %}
{% block content %}
<div class="page-header">
    <h1>Admin Dashboard</h1>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Clients</div>
        <div class="stat-value accent">{{ total_clients }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Active Clients</div>
        <div class="stat-value green">{{ active_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Today's Calls</div>
        <div class="stat-value blue">{{ today_calls }}</div>
    </div>
</div>

<!-- CREATE CLIENT -->
<div class="card" style="margin-bottom:24px;">
    <div class="card-header"><h3>Create Client</h3></div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin_create_client') }}">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                <div class="form-group" style="margin:0;"><label>Name *</label><input type="text" name="name" class="form-control" required></div>
                <div class="form-group" style="margin:0;"><label>Email *</label><input type="email" name="email" class="form-control" required></div>
                <div class="form-group" style="margin:0;"><label>Password *</label><input type="text" name="password" class="form-control" required></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px;">
                <div class="form-group" style="margin:0;"><label>Phone</label><input type="tel" name="phone" class="form-control" placeholder="+44..."></div>
                <div class="form-group" style="margin:0;"><label>Business Name *</label><input type="text" name="business_name" class="form-control" required></div>
                <div class="form-group" style="margin:0;"><label>Business Type</label><input type="text" name="business_type" class="form-control" placeholder="Plumbing, Dental..."></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
                <div class="form-group" style="margin:0;"><label>Tier</label>
                    <select name="tier" class="form-control"><option value="starter">Starter</option><option value="growth" selected>Growth</option><option value="enterprise">Enterprise</option></select>
                </div>
                <div class="form-group" style="margin:0;"><label>Status</label>
                    <select name="status" class="form-control"><option value="active" selected>Active</option><option value="pending">Pending</option></select>
                </div>
            </div>
            <div class="form-group" style="margin:12px 0 0;"><label>Greeting</label><textarea name="greeting" class="form-control" rows="2" placeholder="Hello, thank you for calling..."></textarea></div>
            <div class="form-group" style="margin:12px 0 0;"><label>Prompt</label><textarea name="agent_personality" class="form-control" rows="3" placeholder="You are a friendly receptionist for [Business]..."></textarea></div>
            <button type="submit" class="btn btn-primary btn-sm" style="margin-top:12px;">Create Client</button>
        </form>
    </div>
</div>

<!-- ALL USERS -->
<div class="card" style="margin-bottom:24px;">
    <div class="card-header"><h3>All Users</h3></div>
    <div class="card-body no-pad">
        {% if all_users %}
        <table class="data-table">
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>
            {% for u in all_users %}
            <tr>
                <td>{{ u.name }}</td>
                <td style="font-size:0.85rem;">{{ u.email }}</td>
                <td><span class="badge badge-neutral">{{ u.role }}</span></td>
                <td><span class="badge badge-{{ u.status }}">{{ u.status }}</span></td>
                <td style="font-size:0.85rem;">{{ u.created_at.strftime('%d %b %H:%M') if u.created_at else '-' }}</td>
                <td style="display:flex;gap:6px;">
                    {% if u.role == 'client' and u.status != 'active' %}
                    <form method="POST" action="{{ url_for('admin_activate_client', user_id=u.id) }}"><button class="btn btn-sm btn-primary">Activate</button></form>
                    {% endif %}
                    {% if u.role == 'client' and u.status == 'active' %}
                    <form method="POST" action="{{ url_for('admin_suspend_client', user_id=u.id) }}"><button class="btn btn-sm" style="background:#ef4444;color:#fff;">Suspend</button></form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><h3>No users yet</h3></div>
        {% endif %}
    </div>
</div>

<!-- PHONE NUMBERS -->
<div class="card" style="margin-bottom:24px;">
    <div class="card-header"><h3>Phone Numbers</h3></div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin_add_number') }}" style="margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border-color);">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                <div class="form-group" style="margin:0;"><label>Number *</label><input type="text" name="number" class="form-control" placeholder="+447123456789" required></div>
                <div class="form-group" style="margin:0;"><label>Label</label><input type="text" name="label" class="form-control" placeholder="Sales, Support"></div>
                <div class="form-group" style="margin:0;"><label>Business</label>
                    <select name="business_id" class="form-control"><option value="">— Unassigned —</option>{% for b in businesses %}<option value="{{ b.id }}">{{ b.name }}</option>{% endfor %}</select>
                </div>
            </div>
            <div class="form-group" style="margin:12px 0 0;"><label>Greeting</label><textarea name="greeting" class="form-control" rows="2" placeholder="Hello, thank you for calling..."></textarea></div>
            <div class="form-group" style="margin:12px 0 0;"><label>Prompt</label><textarea name="agent_personality" class="form-control" rows="3" placeholder="You are a friendly receptionist..."></textarea></div>
            <button type="submit" class="btn btn-primary btn-sm" style="margin-top:12px;">Add Number</button>
        </form>
        {% if phone_numbers %}
        <table class="data-table">
            <thead><tr><th>Number</th><th>Label</th><th>Business</th><th>Greeting</th><th>Prompt</th><th>Actions</th></tr></thead>
            <tbody>
            {% for n in phone_numbers %}
            <tr>
                <td style="font-family:var(--font-mono);font-size:0.85rem;">{{ n.number }}</td>
                <td>{{ n.label or '—' }}</td>
                <td>{{ n.business_name or '—' }}</td>
                <td style="font-size:0.75rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ n.greeting or '—' }}</td>
                <td style="font-size:0.75rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ n.agent_personality or '—' }}</td>
                <td>
                    <form method="POST" action="{{ url_for('admin_delete_number', number_id=n.id) }}" onsubmit="return confirm('Delete?')" style="display:inline;">
                        <button class="btn btn-sm" style="background:#ef4444;color:#fff;">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<!-- ONBOARDING CALLS -->
<div class="card" style="margin-bottom:24px;">
    <div class="card-header"><h3>Onboarding Calls</h3></div>
    <div class="card-body no-pad">
        {% if onboarding_calls %}
        <table class="data-table">
            <thead><tr><th>Time</th><th>User</th><th>Business</th><th>Status</th><th>Twilio SID</th><th>Data</th></tr></thead>
            <tbody>
            {% for oc in onboarding_calls %}
            <tr>
                <td style="font-size:0.85rem;white-space:nowrap;">{{ oc.created_at.strftime('%d %b %H:%M') if oc.created_at else '-' }}</td>
                <td>{{ oc.user_name or '-' }}<br><span style="font-size:0.75rem;color:var(--text-muted);">{{ oc.user_email or '' }}</span></td>
                <td>{{ oc.business_name or '-' }}</td>
                <td><span class="badge badge-{{ oc.status }}">{{ oc.status }}</span></td>
                <td style="font-family:var(--font-mono);font-size:0.75rem;">{{ oc.twilio_call_sid or '-' }}</td>
                <td style="font-size:0.75rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;">{{ oc.extracted_data or '-' }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><h3>No onboarding calls yet</h3></div>
        {% endif %}
    </div>
</div>

<!-- RECENT CALLS -->
<div class="card">
    <div class="card-header"><h3>Recent Calls</h3></div>
    <div class="card-body no-pad">
        {% if recent_calls %}
        <table class="data-table">
            <thead><tr><th>Time</th><th>Business</th><th>Caller</th><th>Category</th><th>Sentiment</th><th>Duration</th></tr></thead>
            <tbody>
            {% for c in recent_calls %}
            <tr>
                <td style="font-size:0.85rem;white-space:nowrap;">{{ c.created_at.strftime('%d %b %H:%M') if c.created_at else '-' }}</td>
                <td>{{ c.business_name or '-' }}</td>
                <td style="font-family:var(--font-mono);font-size:0.85rem;">{{ c.caller_number or '-' }}</td>
                <td><span class="badge badge-neutral">{{ c.category or '-' }}</span></td>
                <td><span class="badge badge-{{ c.sentiment or 'neutral' }}-s">{{ c.sentiment or '-' }}</span></td>
                <td>{{ ((c.duration_seconds or 0) / 60)|round(1) }}m</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><h3>No calls yet</h3></div>
        {% endif %}
    </div>
</div>
{% endblock %}
